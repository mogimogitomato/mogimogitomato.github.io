<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ja-jp">
<head>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-56274201-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-56274201-3');
</script>


<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>puppeteerで駿河屋の商品情報を取得する | ツナ缶同盟</title>

<meta property='og:title' content='puppeteerで駿河屋の商品情報を取得する - ツナ缶同盟'>
<meta property='og:description' content='本日のBGM 以下本題です。 動機 中古の商品を探す際、メル◯リの様に指定の検索条件に対して入荷があった場合に通知を受け取れると 便利ですが、愛する'>
<meta property='og:url' content='https://mogimogitomato.github.io/post/20190214/'>
<meta property='og:site_name' content='ツナ缶同盟'>
<meta property='og:type' content='article'><meta property='og:image' content='https://mogimogitomato.github.io/images/icons/icon-192x192.png'><meta property='article:published_time' content='2019-02-14T01:39:16&#43;09:00'/><meta property='article:modified_time' content='2019-02-14T01:39:16&#43;09:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@freefish22'><meta name='twitter:creator' content='@freefish22'>


<link href="https://mogimogitomato.github.io/index.xml" rel="alternate" type="application/rss+xml" title="ツナ缶同盟" />

<link rel="stylesheet" href="/css/style.min.css"/><link rel='stylesheet' href='https://mogimogitomato.github.io/css/custom.min.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json" />
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono|Inconsolata|Bad+Script">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/yakuhanjp@3.0.0/dist/css/yakuhanjp.min.css">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://mogimogitomato.github.io/">
          <h1 class="title is-4">ツナ缶同盟</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/mogimogitomato'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/freefish22'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="soundcloud" href='https://soundcloud.com/freefish19'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 17H5a2 2 0 0 0-2 2 2 2 0 0 0 2 2h2a2 2 0 0 0 2-2zm12-2h-4a2 2 0 0 0-2 2 2 2 0 0 0 2 2h2a2 2 0 0 0 2-2z"/>
    <polyline points="9 17 9 5 21 3 21 15"/>
    
  </svg>
</i>
            </span>
          </a></nav>
      </div>
    </nav>

    
    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/">
          <h2 class="title is-5">Home</h2>
        </a><a class="nav-item" href="/archives">
          <h2 class="title is-5">Archive</h2>
        </a><a class="nav-item" href="/categories">
          <h2 class="title is-5">Category</h2>
        </a><a class="nav-item" href="/tags">
          <h2 class="title is-5">Tag</h2>
        </a></div>
      

      
    </nav>
    <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
    <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
    <div class="aa-input-container" id="aa-input-container">
        <input type="search" id="aa-search-input" class="aa-input-search" placeholder="" name="search" autocomplete="on" />
        <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
            <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
        </svg>
    </div>
    <script>
    var client = algoliasearch("ZCGMXWE4XB", "364f6f97ad28a99c1c44d4ea51381b12");
    var index = client.initIndex('tuna-can');
    autocomplete('#aa-search-input',
    { hint: true}, {
        source: autocomplete.sources.hits(index, {hitsPerPage: 8}),
        displayKey: 'name',
        templates: {
            suggestion: function(suggestion) {
                return '<span>' + '<a href="' + suggestion.permalink + '">' +
                suggestion._highlightResult.title.value + '</a></span>';
            },
            footer: '<div style="border-top: 1px solid rgba(228, 228, 228, 0.6); padding: 12px; display: block; font-size:14px;">Powered by <a href="http://www.algolia.com"><img src="https://www.algolia.com/assets/algolia128x40.png" style="height: 14px; margin: 0 0 -3px 5px;" ></a></div>'
        }
    });
    </script>
  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/puppeteer">#puppeteer</a>



      
    </div>
    <h2 class="subtitle is-6">February 14, 2019</h2>
    <h1 class="title">puppeteerで駿河屋の商品情報を取得する</h1>
    
    <div class="content">
      

<p></br>
<p style="text-align:center;">本日のBGM</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/2ae8ClqproY" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

</br>
<p>以下本題です。</p></p>

<h2 id="動機">動機</h2>

<p>中古の商品を探す際、メル◯リの様に指定の検索条件に対して入荷があった場合に通知を受け取れると<br />
便利ですが、愛する駿河屋では商品単位でしか通知を受け取ることができず、駿河屋の登録履歴にない<br />
新規入荷した商品の有無は都度検索してチェックする必要がありました。<br />
先日<a href="https://github.com/GoogleChrome/puppeteer" target="_blank">puppeteer</a>(Chromiumのヘッドレスブラウザを実行するためのnodeライブラリ)を知り、<br />
検索行為を自動化して商品情報を取得できるか試してみました。<br />
※puppeteerの概要やセットアップ手順などの詳細はリンクの公式サイトを参照下さい。</p>

<h2 id="結果">結果</h2>

<p>結論だけ、書く。<br />
以下のスクリプトを作成しました。</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;puppeteer&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">TARGET_URL</span> <span class="o">=</span> <span class="s1">&#39;https://www.suruga-ya.jp/&#39;</span><span class="p">;</span>
<span class="k">const</span> <span class="nx">SEARCH_WORDS</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">getScrapingData</span><span class="p">(</span><span class="nx">search_word</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">browser</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">puppeteer</span><span class="p">.</span><span class="nx">launch</span><span class="p">({</span><span class="nx">headless</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
  <span class="k">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">newPage</span><span class="p">()</span>
  <span class="kr">await</span> <span class="nx">page</span><span class="p">.</span><span class="kr">goto</span><span class="p">(</span><span class="nx">TARGET_URL</span><span class="p">,</span> <span class="p">{</span><span class="nx">waitUntil</span><span class="o">:</span> <span class="s1">&#39;networkidle2&#39;</span><span class="p">})</span>
  <span class="kr">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;input[name=search_word]&#39;</span><span class="p">,</span> <span class="nx">search_word</span><span class="p">)</span>
  <span class="k">const</span> <span class="nx">searchElement</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[id=btn]&#39;</span><span class="p">)</span>
  <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">page</span><span class="p">.</span><span class="nx">waitForNavigation</span><span class="p">({</span><span class="nx">waitUntil</span><span class="o">:</span> <span class="s2">&#34;domcontentloaded&#34;</span><span class="p">}),</span>
    <span class="nx">searchElement</span><span class="p">.</span><span class="nx">click</span><span class="p">()</span>
  <span class="p">])</span>
  <span class="k">const</span> <span class="nx">scrapingData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">dataList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">const</span> <span class="nx">itemList</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&#34;div.item&#34;</span><span class="p">))</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="c1">// 商品価格はタイムセールなどで子要素が可変になるため判定
</span><span class="c1"></span>      <span class="kd">let</span> <span class="nx">priceList</span> <span class="o">=</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="kd">let</span> <span class="nx">price</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">priceList</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">priceList</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">className</span> <span class="o">==</span> <span class="s2">&#34;price&#34;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">price</span> <span class="o">=</span> <span class="nx">priceList</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
          <span class="k">break</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">textContent</span><span class="p">,</span>
        <span class="nx">price</span><span class="o">:</span> <span class="nx">price</span><span class="p">.</span><span class="nx">textContent</span>
      <span class="p">}</span>　
      <span class="nx">dataList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">dataList</span>
  <span class="p">})</span>
  <span class="k">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">({[</span><span class="nx">search_word</span><span class="p">]</span><span class="o">:</span> <span class="nx">scrapingData</span><span class="p">})</span>
  <span class="k">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">)</span>
  <span class="kr">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">getScrapingData</span><span class="p">(</span><span class="nx">SEARCH_WORDS</span><span class="p">)</span>
</code></pre></div>
<p>実行してみる</p>

<pre><code>~/Desktop/puppeteer via ⬢ v10.7.0
➜ node surugaya_search.js marisada
</code></pre>

<p>取れた！！</p>

<pre><code>~/Desktop/puppeteer via ⬢ v10.7.0 took 2s
➜ node surugaya_search.js marisada
[
 {
  &quot;marisada&quot;: [
   {
    &quot;url&quot;: &quot;https://www.suruga-ya.jp/product/detail/186129095001&quot;,
    &quot;title&quot;: &quot;wijnruit / Marisada&quot;,
    &quot;price&quot;: &quot;￥250 税込&quot;
   }
  ]
 }
]
</code></pre>

<h2 id="todo">TODO</h2>

<ul>
<li>現状の作りだと引数を1つしか渡せないので、検索条件1件の結果しか受けられない。<br />
複数の検索条件を渡した場合それぞれ非同期で検索し、待ち合わせてまとめて結果が返る様にしたい。<br /></li>
<li>前回実行結果を保持して、実行時に取得結果と比較して差分を検知した場合メール等で通知を送れる様にしたい。<br /></li>
</ul>

<h2 id="結び">結び</h2>

<p>puppeteer便利！</p>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>


<section class="section sns_parent">
  <p>+----- Share ? -----+</p>
  <div class="container sns_section">
      <div class="sns_button twitter">
        <a class="sns_icon" href="http://twitter.com/intent/tweet?url=https%3a%2f%2fmogimogitomato.github.io%2fpost%2f20190214%2f&text=puppeteer%e3%81%a7%e9%a7%bf%e6%b2%b3%e5%b1%8b%e3%81%ae%e5%95%86%e5%93%81%e6%83%85%e5%a0%b1%e3%82%92%e5%8f%96%e5%be%97%e3%81%99%e3%82%8b" target="_blank" title="Tweet">
          <span class="icon">
            <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg>
</i>
          </span>
        </a>
      </div>
      <div class="sns_button hateb">
        <a class="sns_icon" href="http://b.hatena.ne.jp/add?mode=confirm&url=https%3a%2f%2fmogimogitomato.github.io%2fpost%2f20190214%2f&title=puppeteer%e3%81%a7%e9%a7%bf%e6%b2%b3%e5%b1%8b%e3%81%ae%e5%95%86%e5%93%81%e6%83%85%e5%a0%b1%e3%82%92%e5%8f%96%e5%be%97%e3%81%99%e3%82%8b" target="_blank" title="hatena">
          <span class="icon">
            <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
    
  </svg>
</i>
          </span>
        </a>
      </div>
      <div class="sns_button facebook">
        <a class="sns_icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmogimogitomato.github.io%2fpost%2f20190214%2f&t=puppeteer%e3%81%a7%e9%a7%bf%e6%b2%b3%e5%b1%8b%e3%81%ae%e5%95%86%e5%93%81%e6%83%85%e5%a0%b1%e3%82%92%e5%8f%96%e5%be%97%e3%81%99%e3%82%8b" target="_blank" title="Facebook">
          <span class="icon">
            <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
    
  </svg>
</i>
          </span>
        </a>
      </div>
      <div class="sns_button pocket">
        <a class="sns_icon" href="http://getpocket.com/edit?url=https%3a%2f%2fmogimogitomato.github.io%2fpost%2f20190214%2f&title=puppeteer%e3%81%a7%e9%a7%bf%e6%b2%b3%e5%b1%8b%e3%81%ae%e5%95%86%e5%93%81%e6%83%85%e5%a0%b1%e3%82%92%e5%8f%96%e5%be%97%e3%81%99%e3%82%8b" target="_blank" title="pocket">
          <span class="icon">
            <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 3h16a2 2 0 0 1 2 2v6a10 10 0 0 1-10 10A10 10 0 0 1 2 11V5a2 2 0 0 1 2-2z"/>
    <polyline points="8 10 12 14 16 10"/>
    
  </svg>
</i>
          </span>
        </a>
      </div>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/mogimogitomato">YK</a> 2019</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>
<script>
   if('serviceWorker' in navigator) {
     navigator.serviceWorker.register('/sw.js')
   }
 </script>


</body>
</html>

